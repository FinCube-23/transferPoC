# Database Schema Migration Guide

## Overview

This guide documents the database schema changes made to the b2b-membership backend and provides instructions for migrating existing data.

## Schema Changes

### Organization Model Changes

#### Removed Fields

-   `reference_key` (String, unique, auto-generated) - **REMOVED**

#### Added Fields

-   `org_id` (Number, unique, required, not auto-generated) - **NEW**
-   `wallet_address` (String, unique, required, not auto-generated) - **NEW**

#### Unchanged Fields

-   `_id` (ObjectId, auto-generated by MongoDB)
-   `org_salt` (String, unique, auto-generated)

### User Model Changes

#### Added Fields

-   `user_id` (Number, unique, required, not auto-generated) - **NEW**
-   `zkp_key` (String, unique, required) - **NEW**

#### Unchanged Fields

-   `_id` (ObjectId, auto-generated by MongoDB)
-   `batch_id` (ObjectId, foreign key reference)
-   `balance` (Number, default 0, non-negative)
-   `reference_number` (String, unique when not null, sparse index)

## Migration Steps

### Step 1: Backup Your Database

Before making any changes, create a backup of your database:

```bash
mongodump --db b2b_membership --out ./backup
```

### Step 2: Update Application Code

The application code has already been updated with the new schema. Ensure you have the latest version:

```bash
git pull origin main
```

### Step 3: Drop Existing Indexes

Run the fix-indexes script to drop old indexes and create new ones:

```bash
cd backend/b2b-membership
node fix-indexes.js
```

### Step 4: Migrate Existing Data

If you have existing data in your database, you'll need to migrate it. Here's a sample migration script:

```javascript
// migrate-data.js
const { connectDatabase, disconnectDatabase } = require("./utils/database")
const mongoose = require("mongoose")

async function migrateData() {
    try {
        await connectDatabase()
        const db = mongoose.connection.db

        // Migrate Organizations
        console.log("Migrating organizations...")
        const orgsCollection = db.collection("organizations")
        const organizations = await orgsCollection.find({}).toArray()

        for (let i = 0; i < organizations.length; i++) {
            const org = organizations[i]

            // Generate org_id if not exists
            const org_id = 1000 + i + 1

            // Use reference_key as wallet_address or generate a placeholder
            const wallet_address =
                org.reference_key || `0x${org._id.toString()}`

            await orgsCollection.updateOne(
                { _id: org._id },
                {
                    $set: {
                        org_id: org_id,
                        wallet_address: wallet_address,
                    },
                    $unset: {
                        reference_key: "",
                    },
                }
            )
        }
        console.log(`✓ Migrated ${organizations.length} organizations`)

        // Migrate Users
        console.log("Migrating users...")
        const usersCollection = db.collection("users")
        const users = await usersCollection.find({}).toArray()

        for (let i = 0; i < users.length; i++) {
            const user = users[i]

            // Generate user_id if not exists
            const user_id = 2000 + i + 1

            // Generate zkp_key (you may want to use a more sophisticated method)
            const zkp_key = `zkp_${user._id.toString()}`

            await usersCollection.updateOne(
                { _id: user._id },
                {
                    $set: {
                        user_id: user_id,
                        zkp_key: zkp_key,
                    },
                }
            )
        }
        console.log(`✓ Migrated ${users.length} users`)

        await disconnectDatabase()
        console.log("\n✓ Migration complete")
        process.exit(0)
    } catch (error) {
        console.error("✗ Migration failed:", error.message)
        await disconnectDatabase()
        process.exit(1)
    }
}

migrateData()
```

Save this as `migrate-data.js` and run it:

```bash
node migrate-data.js
```

### Step 5: Verify Migration

Run the test suite to verify everything works correctly:

```bash
node test-models.js
```

Check the indexes:

```bash
node check-indexes.js
```

### Step 6: Clean Start (Alternative)

If you don't have important data to preserve, you can start fresh:

```bash
# Connect to MongoDB
mongo

# Drop the database
use b2b_membership
db.dropDatabase()

# Exit mongo shell
exit

# Run tests to recreate collections with new schema
node test-models.js
```

## Important Notes

### Organization Model

-   `org_id` must be unique across all organizations
-   `wallet_address` must be unique and should be a valid Ethereum address format
-   `org_salt` is still auto-generated on creation

### User Model

-   `user_id` must be unique across all users
-   `zkp_key` must be unique and is required for all users
-   Existing validation rules (balance non-negative, reference_number uniqueness) remain unchanged

## API Changes

### Creating Organizations

**Before:**

```javascript
const org = new Organization({})
// reference_key was auto-generated
```

**After:**

```javascript
const org = new Organization({
    org_id: 1001,
    wallet_address: "0x1234567890123456789012345678901234567890",
})
// org_id and wallet_address must be provided
```

### Creating Users

**Before:**

```javascript
const user = new User({
    batch_id: batchId,
    balance: 100,
    reference_number: "REF-001",
})
```

**After:**

```javascript
const user = new User({
    user_id: 2001,
    batch_id: batchId,
    balance: 100,
    reference_number: "REF-001",
    zkp_key: "zkp_key_001",
})
// user_id and zkp_key must be provided
```

## Rollback Procedure

If you need to rollback the changes:

1. Restore from backup:

```bash
mongorestore --db b2b_membership ./backup/b2b_membership
```

2. Revert to the previous version of the code:

```bash
git checkout <previous-commit-hash>
```

3. Restart the application

## Testing

After migration, run the complete test suite:

```bash
node run-all-tests.js
```

Expected output:

-   All tests should pass
-   New uniqueness constraints should be enforced
-   Auto-generation should only apply to org_salt

## Support

If you encounter issues during migration, check:

1. MongoDB connection is working
2. All required fields are provided when creating new documents
3. Unique constraints are not violated
4. Indexes are properly created

For additional help, review the test files:

-   `test-models.js` - Shows correct usage of new schema
-   `fix-indexes.js` - Handles index recreation
-   `check-indexes.js` - Verifies index configuration
