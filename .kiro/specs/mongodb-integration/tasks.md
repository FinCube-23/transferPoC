# Implementation Plan

-   [x] 1. Install dependencies and update configuration

    -   Install mongoose package
    -   Add fast-check for property-based testing
    -   Update .env.example with MongoDB configuration
    -   Extend config/config.js with database configuration section
    -   _Requirements: 1.5, 6.1, 6.2, 6.3, 6.4, 6.5_

-   [x] 2. Create database connection utility

    -   Create utils/database.js with connection management functions
    -   Implement connectDatabase() function with error handling
    -   Implement disconnectDatabase() function for graceful shutdown
    -   Add connection event listeners for success and error logging
    -   _Requirements: 1.1, 1.2, 1.3, 1.4_

-   [ ]\* 2.1 Write property test for database connection lifecycle

    -   **Property 1: Database connection lifecycle**
    -   **Validates: Requirements 1.1, 1.2, 1.3, 1.4**

-   [x] 3. Create Batch model

    -   Create models/batch.js with Mongoose schema
    -   Define \_id as primary key (auto-generated by MongoDB)
    -   Define equation field as array of strings
    -   Add validation for equation array structure
    -   Export Batch model
    -   _Requirements: 4.1, 4.2, 4.3, 4.4, 5.1, 5.2, 5.3, 5.4_

-   [ ]\* 3.1 Write property test for batch equation array structure

    -   **Property 8: Batch equation array structure**
    -   **Validates: Requirements 4.4**

-   [x] 4. Create User model

    -   Create models/user.js with Mongoose schema
    -   Define \_id as primary key (auto-generated by MongoDB)
    -   Define batch_id as ObjectId reference to Batch model
    -   Define balance field with default 0 and minimum 0 validation
    -   Define reference_number as unique sparse string field
    -   Add sparse unique index for reference_number
    -   Export User model
    -   _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 5.1, 5.2, 5.3, 5.4_

-   [ ]\* 4.1 Write property test for user balance non-negativity

    -   **Property 2: User balance non-negativity**
    -   **Validates: Requirements 2.4**

-   [ ]\* 4.2 Write property test for reference number uniqueness

    -   **Property 3: Reference number uniqueness**
    -   **Validates: Requirements 2.5, 2.6**

-   [ ]\* 4.3 Write unit tests for User model

    -   Test creating user with valid data
    -   Test negative balance rejection
    -   Test null reference_number handling
    -   Test duplicate reference_number rejection
    -   _Requirements: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_

-   [x] 5. Create Organization model

    -   Create models/organization.js with Mongoose schema
    -   Define \_id as primary key (auto-generated by MongoDB)
    -   Define reference_key as unique string field
    -   Define org_salt as unique string field
    -   Implement pre-save hook to auto-generate reference_key using UUID v4
    -   Implement pre-save hook to auto-generate org_salt using crypto.randomBytes
    -   Add unique indexes for reference_key and org_salt
    -   Export Organization model
    -   _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 5.1, 5.2, 5.3, 5.4_

-   [ ]\* 5.1 Write property test for organization reference_key uniqueness

    -   **Property 5: Organization reference_key uniqueness**
    -   **Validates: Requirements 3.3, 3.6**

-   [ ]\* 5.2 Write property test for organization org_salt uniqueness

    -   **Property 6: Organization org_salt uniqueness**
    -   **Validates: Requirements 3.5, 3.7**

-   [ ]\* 5.3 Write property test for auto-generation on creation

    -   **Property 7: Auto-generation on creation**
    -   **Validates: Requirements 3.3, 3.5**

-   [ ]\* 5.4 Write unit tests for Organization model

    -   Test auto-generation of reference_key
    -   Test auto-generation of org_salt
    -   Test reference_key is valid UUID format
    -   Test org_salt is valid hex string
    -   Test uniqueness constraints
    -   _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7_

-   [x] 6. Integrate database connection with application

    -   Update index.js to import database connection utility
    -   Call connectDatabase() before starting Express server
    -   Add graceful shutdown handler to call disconnectDatabase()
    -   Add error handling for database connection failures
    -   Update health check endpoint to include database status
    -   _Requirements: 1.1, 1.2, 1.3, 1.4_

-   [ ]\* 6.1 Write integration tests for database lifecycle

    -   Test connection establishment on startup
    -   Test graceful disconnection on shutdown
    -   Test database operations after connection
    -   Test error handling for connection failures
    -   _Requirements: 1.1, 1.2, 1.3, 1.4_

-   [x] 7. Checkpoint - Ensure all tests pass
    -   Ensure all tests pass, ask the user if questions arise.
